# 워크플로우 이름
name: PR Check & Release on Tag

# 워크플로우 트리거 조건
on:
  # PR 시: main 브랜치 대상 Pull Request
  pull_request:
    branches: [ main ]
    paths:
     - '.github/**' # 워크플로우 변경 감지
     - 'library/**' # src 변경 감지
     - 'gradle/**' # Gradle 의존성 및 버전 변경감지
     - 'gradle.properties' # 프로젝트 속성값 변경 감지

  # 릴리스 시: v* 태그 변경감지 푸시 (릴리스 버저닝)
  push:
    tags:
      - 'v*' # 시맨틱 버전 태그 (예: v1.0.0, v1.2.3-rc1)

  # 수동 실행 (릴리스 목적)
  workflow_dispatch:

# 브랜치 보호 규칙 안내 수정
# 중요: GitHub 저장소 설정에서 'main' 브랜치 보호 규칙(Branch Protection Rule)을
# 설정하고, 아래 'lint-test' Job (또는 그 name인 'Lint, Test & Validate Version')을
# 필수 상태 검사(Required status checks)로 지정해야 PR 병합 전 검증이 수행됩니다.

jobs:
  # =============================================================================
  # Job 1: 코드 린팅, 테스트 및 버전 유효성 검증 (PR 시에만 버전 검증 실행)
  # =============================================================================
  lint-test:
    name: Lint, Test & Validate Version
    # 재사용 워크플로우 호출
    uses: ./.github/workflows/_reusable-setup.yml # 경로 확인 필요
    with:
      fetch-depth: 0 # 모든 태그 가져오기 위해 필요

    # lint-test 잡의 추가 스텝 (재사용 워크플로우 실행 *후* 실행)
    steps:
      # Setup steps (checkout, java, gradle, chmod) are handled by reusable workflow defined in _reusable-setup.yml

      - name: Run Checks & Linters
        run: ./gradlew check ktlintCheck --build-cache

      # --- PR 시 버전 유효성 검증 ---
      - name: Get latest release tag
        id: get_latest_tag
        if: github.event_name == 'pull_request' # PR 시에만 실행
        uses: actions-ecosystem/action-get-latest-tag@v1
        with: { semver_only: true, with_initial_version: true, initial_version: "0.0.0" }

      - name: Validate version increment vs latest release
        if: github.event_name == 'pull_request'
        run: ./.github/workflows/scripts/validate-version.sh
        env:
          # 스크립트에 최신 태그 전달
          INPUT_LATEST_RELEASE_TAG: ${{ steps.get_latest_tag.outputs.tag }}

  # =============================================================================
  # Job 2: 플랫폼별 빌드 (릴리스 시 실행)
  # =============================================================================
  build:
    name: Build Multi-Platform (${{ matrix.os }})
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    needs: lint-test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact-name: non-apple-binaries
            build-script: ./.github/workflows/scripts/build-non-apple.sh
            setup-xcode: false
          - os: macos-latest
            artifact-name: apple-binaries
            build-script: ./.github/workflows/scripts/build-apple.sh
            setup-xcode: true
            xcode-version: '15.2' # 필요 시 Xcode 버전 지정

    # 재사용 워크플로우 호출
    uses: ./.github/workflows/_reusable-setup.yml # 경로 확인 필요
    with:
      setup-xcode: ${{ matrix.setup-xcode }}
      xcode-version: ${{ matrix.xcode-version || 'latest' }}
      # cache-read-only: false # 재사용 워크플로우 내 Gradle 설정에서 처리하거나 여기서 전달

    # build 잡의 추가 스텝 (재사용 워크플로우 실행 *후* 실행)
    steps:
      # Setup steps are handled by reusable workflow

      # Matrix에 정의된 빌드 스크립트 실행
      - name: Build targets for ${{ matrix.os }}
        run: ${{ matrix.build-script }}

      # Matrix에 정의된 이름으로 빌드 아티팩트 업로드
      - name: Upload ${{ matrix.artifact-name }} build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: library/build/bin/*/releaseShared/
          retention-days: 1

  # =============================================================================
  # Job 3: 패키징 및 릴리스 (Git 태그 푸시 및 수동 워크플로 실행 시)
  # =============================================================================
  package-release:
    name: Package and Release
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    needs: [build] # Matrix 빌드 잡 전체에 의존
    permissions:
      contents: write # 릴리스 생성 및 에셋 업로드를 위해 필요

    # 재사용 워크플로우 호출
    uses: ./.github/workflows/_reusable-setup.yml # 경로 확인 필요
    with:
      ref: ${{ github.ref }} # 릴리스 대상 태그/커밋 체크아웃

    # package-release 잡의 추가 스텝 (재사용 워크플로우 실행 *후* 실행)
    steps:
      # Setup steps are handled by reusable workflow

      - name: Get Version from Properties
        id: version
        run: ./.github/workflows/scripts/get-version-from-properties.sh

      # 태그 푸시 이벤트일 경우 태그 유효성 검증
      - name: Validate Tag matches from gradle.properties `libVersion`
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: ./.github/workflows/scripts/validate-tag.sh
        env:
          INPUT_PUSHED_TAG: ${{ github.ref_name }}
          INPUT_VERSION_TAG_FROM_PROPS: ${{ steps.version.outputs.version_tag }}
          INPUT_COMMIT_SHA: ${{ github.sha }}

      # Matrix 빌드에서 생성된 모든 아티팩트 다운로드
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with: { path: downloaded-artifacts }

      # 릴리스 에셋 준비
      - name: Prepare Release Assets (Rename binaries)
        run: ./.github/workflows/scripts/prepare-release-assets.sh downloaded-artifacts release-assets

      # 릴리스 본문 생성 스크립트 실행
      - name: Generate Release Body
        run: ./.github/workflows/scripts/generate-release-body.sh
        env:
          INPUT_VERSION_TAG: ${{ steps.version.outputs.version_tag }}
          INPUT_ASSETS_DIR: release-assets
          OUTPUT_BODY_FILE: .github/release-body.md

      # Zip 아카이브 생성
      - name: Create zip archive
        id: zip
        run: ./.github/workflows/scripts/create-zip-archive.sh
        env:
          INPUT_VERSION_NUM: ${{ steps.version.outputs.version_num }}

      # GitHub 릴리스 생성 및 에셋 업로드
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: Release ${{ steps.version.outputs.version_num }}
          body_path: .github/release-body.md
          draft: false
          prerelease: false
          files: |
            ${{ steps.zip.outputs.zip_name }}
            release-assets/*/*
          # generate_release_notes: true # 선택 사항
