# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: PR Check & Release on Tag

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # PR ì‹œ: main ë¸Œëœì¹˜ ëŒ€ìƒ Pull Request
  pull_request:
    branches: [ main ]
    paths:
     - '.github/**' # ì›Œí¬í”Œë¡œìš° ë³€ê²½ ê°ì§€
     - 'library/**' # src ë³€ê²½ ê°ì§€
     - 'gradle.properties' # ë°”ì´ë„ˆë¦¬ëª… ë³€ê²½ ê°ì§€
     - 'gradle/**' # Gradle Wrapper ë³€ê²½ ê°ì§€

  # ë¦´ë¦¬ìŠ¤ ì‹œ: v* íƒœê·¸ ë³€ê²½ê°ì§€ í‘¸ì‹œ (ë¦´ë¦¬ìŠ¤ ë²„ì €ë‹)
  push:
    tags:
      - 'v*' # ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ (ì˜ˆ: v1.0.0, v1.2.3-rc1)

  # ìˆ˜ë™ ì‹¤í–‰ (ë¦´ë¦¬ìŠ¤ ëª©ì )
  workflow_dispatch:
    inputs:
      version:
        description: 'ë¦´ë¦¬ìŠ¤ ë²„ì „ (ì˜ˆ: 1.0.0). íƒœê·¸ ì´ë¦„ì—ì„œ ìë™ ì¶”ì¶œë˜ë¯€ë¡œ ë³´í†µ ë¹„ì›Œë‘¡ë‹ˆë‹¤.'
        required: false
        default: ''

# =============================================================================
# ì¤‘ìš”: GitHub ì €ì¥ì†Œ ì„¤ì •ì—ì„œ 'main' ë¸Œëœì¹˜ ë³´í˜¸ ê·œì¹™(Branch Protection Rule)ì„
# ì„¤ì •í•˜ê³ , ì•„ë˜ 'lint-test', 'build-non-apple', 'build-apple' Jobë“¤ì„
# í•„ìˆ˜ ìƒíƒœ ê²€ì‚¬(Required status checks)ë¡œ ì§€ì •í•´ì•¼ PR ë³‘í•© ì „ ê²€ì¦ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.
# =============================================================================

jobs:
  # =============================================================================
  # Job 1: ì½”ë“œ ë¦°íŒ… ë° í…ŒìŠ¤íŠ¸ (ëª¨ë“  ê´€ë ¨ íŠ¸ë¦¬ê±°ì—ì„œ ì‹¤í–‰)
  # =============================================================================
  lint-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/gradle-build-action@v3

      - name: Run Checks & Linters
        run: ./gradlew check ktlintCheck --build-cache

  # =============================================================================
  # Job 2: Non-Apple í”Œë«í¼ ë¹Œë“œ (ëª¨ë“  ê´€ë ¨ íŠ¸ë¦¬ê±°ì—ì„œ ì‹¤í–‰)
  # =============================================================================
  build-non-apple:
    name: Build Non-Apple (Linux, Android, Windows)
    runs-on: ubuntu-latest
    needs: lint-test # lint-test Job ì„±ê³µ í›„ ì‹¤í–‰
    # [ìˆ˜ì •] ë¦´ë¦¬ìŠ¤ ì‹œì—ë§Œ ì•„í‹°íŒ©íŠ¸ê°€ í•„ìš”í•˜ë¯€ë¡œ ì¡°ê±´ë¶€ Output ì„¤ì •
    outputs:
      artifact-name: ${{ (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch') && 'non-apple-binaries' || '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/gradle-build-action@v3
        with:
          # main/tag ì•„ë‹ˆë©´ ìºì‹œ ì“°ê¸° ë°©ì§€ (PRì€ ì½ê¸°ë§Œ)
          # main/tag ì•„ë‹ˆë©´ ì“°ê¸° ë°©ì§€
          cache-read-only: ${{ github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/') }}

      - name: Build Non-Apple targets
        run: |
          ./gradlew --build-cache \
                    :library:linkReleaseSharedLinuxX64 \
                    :library:linkReleaseSharedAndroidNativeArm64 \
                    :library:linkReleaseSharedAndroidNativeX64 \
                    :library:linkReleaseSharedMingwX64 \ # (Windows ëŒ€ìƒ ê¸°ë³¸ í…ŒìŠ¤í¬)
                    #:library:linkReleaseSharedWindowsX64 \ # ğŸš« ì»¤ìŠ¤í…€ ë„¤ì´ë° í…ŒìŠ¤í¬
                    # í•„ìš”ì‹œ assembleRelease ë“± ë‹¤ë¥¸ íƒœìŠ¤í¬ ì‚¬ìš©

      # [ìˆ˜ì •] ë¦´ë¦¬ìŠ¤ ì‹œì—ë§Œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (íƒœê·¸ í‘¸ì‹œ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ)
      - name: Upload Non-Apple build artifacts for release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: non-apple-binaries # Outputê³¼ ì¼ì¹˜
          path: |
            library/build/bin/linuxX64/releaseShared/
            library/build/bin/androidNativeArm64/releaseShared/
            library/build/bin/androidNativeX64/releaseShared/
            # library/build/bin/windowsX64/releaseShared/ # ğŸš«
            library/build/bin/mingwX64/releaseShared/
          retention-days: 1

  # =============================================================================
  # Job 3: Apple í”Œë«í¼ ë¹Œë“œ (ëª¨ë“  ê´€ë ¨ íŠ¸ë¦¬ê±°ì—ì„œ ì‹¤í–‰)
  # =============================================================================
  build-apple:
    name: Build Apple (macOS, iOS)
    runs-on: macos-latest
    needs: lint-test
    outputs:
      artifact-name: ${{ (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch') && 'apple-binaries' || '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Set up Gradle
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/') }}

      - name: Build Apple targets
        run: |
          ./gradlew --build-cache \
                    :library:linkReleaseSharedMacosArm64 \
                    :library:linkReleaseSharedMacosX64 \
                    :library:linkReleaseSharedIosArm64 \
                    :library:linkReleaseSharedIosX64 \
                    #:library:linkReleaseSharedIosSimulatorArm64 # í•„ìš” ì‹œ ì¶”ê°€

      # [ìˆ˜ì •] ë¦´ë¦¬ìŠ¤ ì‹œì—ë§Œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload Apple build artifacts for release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: apple-binaries # Outputê³¼ ì¼ì¹˜
          path: |
            library/build/bin/macosArm64/releaseShared/
            library/build/bin/macosX64/releaseShared/
            library/build/bin/iosArm64/releaseShared/
            library/build/bin/iosX64/releaseShared/
            #library/build/bin/iosSimulatorArm64/releaseShared # í•„ìš” ì‹œ ì¶”ê°€
          retention-days: 1

  # =============================================================================
  # Job 4: íŒ¨í‚¤ì§• ë° ë¦´ë¦¬ìŠ¤ (íƒœê·¸ í‘¸ì‹œ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë§Œ ì‹¤í–‰)
  # =============================================================================
  package-release:
    name: Package and Release
    # [ìˆ˜ì •] ì‹¤í–‰ ì¡°ê±´ ëª…í™•í™”: íƒœê·¸ í‘¸ì‹œ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    # [ìˆ˜ì •] ë¹Œë“œ Job ì™„ë£Œ í›„ ì‹¤í–‰
    needs: [build-non-apple, build-apple]
    permissions:
      contents: write # ë¦´ë¦¬ìŠ¤ ìƒì„± ê¶Œí•œ

    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ (ë²„ì „ ê²°ì • ìŠ¤í¬ë¦½íŠ¸ ë“± ì‹¤í–‰ ìœ„í•´)
      - name: Checkout code
        uses: actions/checkout@v4

      # ë²„ì „ ê²°ì • (ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰)
      - name: Determine Version
        id: version
        # ì´ Jobì€ íƒœê·¸/ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë§Œ ë™ì‘í•˜ë¯€ë¡œ if ì¡°ê±´ ë¶ˆí•„ìš”
        run: ./.github/workflows/scripts/github-determine-version.sh
        env:
          WORKFLOW_INPUT_VERSION: ${{ github.event.inputs.version }}
          WORKFLOW_GITHUB_REF: ${{ github.ref }}

      # ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts # ëª¨ë“  ì•„í‹°íŒ©íŠ¸ë¥¼ ì´ í´ë” í•˜ìœ„ì— ë°›ìŒ

      # Zip ì•„ì¹´ì´ë¸Œ ìƒì„±
      - name: Create zip archive
        id: zip
        run: |
          PKG_NAME="platform-binaries-${{ steps.version.outputs.version_num }}"
          ZIP_FILENAME="${PKG_NAME}.zip"
          # ë‹¤ìš´ë¡œë“œëœ ì•„í‹°íŒ©íŠ¸ ë‚´ìš©ë¬¼ë§Œ ì••ì¶• (ìµœìƒìœ„ í´ë” ì œì™¸ ê³ ë ¤)
          # ì˜ˆ: find downloaded-artifacts -mindepth 2 -type f -print | zip ../${ZIP_FILENAME} -@
          # ë˜ëŠ” ê°„ë‹¨í•˜ê²Œ í´ë” ì „ì²´ ì••ì¶•
          cd downloaded-artifacts
          zip -r "../${ZIP_FILENAME}" .
          cd ..
          echo "Zip file created: ${ZIP_FILENAME}"
          echo "zip_name=${ZIP_FILENAME}" >> $GITHUB_OUTPUT

      # GitHub ë¦´ë¦¬ìŠ¤ ìƒì„± ë° ì—ì…‹ ì—…ë¡œë“œ
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: Release ${{ steps.version.outputs.version_num }}
          draft: false
          prerelease: false
          # ì—…ë¡œë“œ íŒŒì¼ ê²½ë¡œ ìˆ˜ì • (ì••ì¶• íŒŒì¼ + ë‹¤ìš´ë¡œë“œëœ ì•„í‹°íŒ©íŠ¸ ë‚´ íŒŒì¼)
          files: |
            ${{ steps.zip.outputs.zip_name }}
            downloaded-artifacts/non-apple-binaries/**/*.so
            downloaded-artifacts/non-apple-binaries/**/*.dll
            downloaded-artifacts/apple-binaries/**/*.dylib
          # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
          generate_release_notes: true
          body: |
            ## Platform binary release ${{ steps.version.outputs.version_tag }}
            **Included Platforms:**
            - Android (arm64, x64)
            - iOS (arm64, x64)
            - macOS (arm64, x64)
            - Windows (x64)
            - Linux (x64)
